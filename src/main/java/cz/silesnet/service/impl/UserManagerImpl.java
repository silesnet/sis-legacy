package cz.silesnet.service.impl;

import cz.silesnet.dao.UserDAO;
import cz.silesnet.model.User;
import cz.silesnet.service.HistoryManager;
import cz.silesnet.service.UserManager;
import cz.silesnet.util.SecurityUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.authentication.event.InteractiveAuthenticationSuccessEvent;
import org.springframework.security.web.authentication.WebAuthenticationDetails;
import org.springframework.security.web.session.HttpSessionDestroyedEvent;

import java.util.List;

/**
 * User manager implementation, mainly to log users in.
 *
 * @author Richard Sikora
 */
public class UserManagerImpl implements UserManager {

  // ~ Instance fields
  // --------------------------------------------------------

  protected final Log log = LogFactory.getLog(getClass());

  private UserDAO dao;

  private HistoryManager hmgr;

  // ~ Methods
  // ----------------------------------------------------------------

  // wired by Spring

  public void setHistoryManager(HistoryManager historyManager) {
    hmgr = historyManager;
  }

  // method used by spring 2 wire HibernateDAO implementation here

  public void setUserDAO(UserDAO dao) {
    this.dao = dao;
  }

  public List getUsers() {
    return dao.getUsers();
  }

  public void dispatchSessionDestroyedEvent(
      HttpSessionDestroyedEvent sessionEvent) {
    log.debug("Dispatching session destroyed event.");
    hmgr.updateLogout(sessionEvent.getSession());

    // TODO kick off user from user cache in acegi
  }

  public void dispatchSuccessfulLoginEvent(
      InteractiveAuthenticationSuccessEvent authEvent) {
    // we have Acegis succesfull login event here, let's store it
    log.debug("Dispatching successful user login event.");
    log.debug("Generated by: " + authEvent.getGeneratedBy());
    // retrieve web authentication details
    WebAuthenticationDetails wad = (WebAuthenticationDetails) ((AbstractAuthenticationToken) authEvent.getSource()).getDetails();
		final User user = dao.getUserByLoginName(SecurityUtils.getUser().getLoginName());
		log.info("'" + user.getLoginName() + "' logged in from " + wad.getRemoteAddress());
		hmgr.insertLogin(user, wad.getRemoteAddress(), wad.getSessionId());
  }
}